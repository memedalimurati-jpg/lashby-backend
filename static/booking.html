<script>
const params = new URLSearchParams(window.location.search);
const date  = params.get("date");
const start = params.get("start");
const end   = params.get("end");
const token = params.get("token");

const info   = document.getElementById("info");
const button = document.querySelector("button");
const price  = document.getElementById("price");
const mainSelect  = document.getElementById("mainService");
const addonSelect = document.getElementById("addonService");

let servicesCache = [];

/* Hvis mangler parametre */
if (!date || !start || !end || !token) {
    info.innerHTML = "❌ Denne booking-linken er ugyldig";
    info.style.color = "red";
    button.disabled = true;
} else {
    document.getElementById("date").value  = date;
    document.getElementById("start").value = start;
    document.getElementById("end").value   = end;
    info.innerHTML = `📅 ${date} ⏰ ${start} – ${end}`;
}

/* LOAD SERVICES */
async function loadServices() {
    try {
        const res = await fetch("/services");
        const data = await res.json();

        servicesCache = [];

        data.services?.forEach(s => {
            servicesCache.push({id:s.id,name:s.name,price:s.price});
        });

        data.packages?.forEach(p => {
            servicesCache.push({id:p.id,name:p.name,price:p.price});
        });

        data.addons?.forEach(a => {
            servicesCache.push({id:a.id,name:a.name,price:a.price});
        });

        servicesCache.forEach(s => {
            const o = document.createElement("option");
            o.value = s.id;
            o.textContent = `${s.name} (${s.price} kr)`;
            mainSelect.appendChild(o);
        });

    } catch {
        info.innerHTML = "❌ Klarte ikke å laste behandlinger";
        info.style.color = "red";
    }
}
loadServices();

/* PRICE UPDATE */
function oppdaterPris() {
    let total = 0;
    const main  = servicesCache.find(s => s.id === mainSelect.value);

    if (main) total += main.price;

    price.textContent = `Totalpris: ${total} kr`;
    button.disabled = !main;
}
mainSelect.addEventListener("change", oppdaterPris);

/* SUBMIT */
document.getElementById("bookingForm").addEventListener("submit", async e => {
    e.preventDefault();

    const name  = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();

    if (!/^\+?\d{8,15}$/.test(phone)) {
        document.getElementById("result").innerText = "❌ Ugyldig telefonnummer";
        return;
    }

    const main  = servicesCache.find(s => s.id === mainSelect.value);

    if (!main) {
        document.getElementById("result").innerText = "❌ Velg behandling";
        return;
    }

    const payload = {
        name:name,
        phone:phone,
        service:main.id,
        addon:null,
        total_price:main.price,
        date:date,
        start_time:start,
        end_time:end,
        token:token
    };

    try {
        const res = await fetch("/bookings", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok) {
            document.getElementById("result").innerText = "✅ Booking bekreftet";
            button.disabled = true;
        } else {
            document.getElementById("result").innerText = "❌ " + (data.detail || "Feil");
        }
    } catch {
        document.getElementById("result").innerText = "❌ Serverfeil";
    }
});
</script>
